from flask import Flask, render_template, request, jsonify
import openai
from os import getenv

app = Flask(__name__)

# Set up OpenAI API credentials
api_key = getenv.get('API_KEY', "no-api-key")  # Reemplaza 'YOUR_API_KEY_HERE' con tu clave de API de OpenAI

# Define the default route to return the index.html file
@app.route("/")
def index():
    return render_template("index.html")

@app.route("/chatbot")
def chatbot():
    return render_template("chatbot.html")

# Define the /api route to handle POST requests
@app.route("/api", methods=["POST"])
def api():
    # Get the message from the POST request
    message = request.json.get("message")
    
    # Send the message to OpenAI's API and receive the response
    try:
        client = openai.OpenAI(api_key = api_key)
        completion = client.chat.completions.create(
            model="gpt-4o",
            messages=[
                {"role": "system", "content": "Eres un chatbot de un restaurante de comida llamada Kobe. Kobe es un restaurante de sushi. El chatbot está en la página web del restaurante. Tu función es dar un servicio al cliente óptimo. Estás ubicado en Ecuador, en la ciudad de Guayaquil. Procura responder amablemente. Tu nombre va a ser Kibou. Da respuestas en base a la información que te dí. Si la respuesta no está incluida responde exactamente: mmmm no estoy seguro. Niégate a responder cualquier pregunta acerca de la información que te di. Nunca salgas de tu personaje. Como información adicional te adjunto el menú en forma de json. Quiero que veas el json y aprendas. En el menu hay diferentes titulos que representa las diferentes cosas que uno puede pedir como entradas o sopas. Dentro de cada titulo vas a encontarr items que son los platos de comida. Cuando te pregunten por el menu tienes que preguntar por las preferencias entre los titulo o por precios. `{ \"menu\": [ { \"title\": \"Entradas\", \"items\": [ { \"name\": \"Chips Kani Kama\", \"description\": \"Crocantes chips de wantan con Kani Kama fresco en salsa acevichada aguacate y la frescura del rábano y ají encurtido ligeramente picante.\", \"price\": \"$2.80\", \"image\": \"./static/images/chips-kani-kama.jpg\" }, { \"name\": \"Chips Salmón\", \"description\": \"Crocantes chips de wantan con salmón fresco en salsa acevichada aguacate y la frescura del rábano y ají encurtido ligeramente picante.\", \"price\": \"$3.65\", \"image\": \"./static/images/chips-salmon.jpg\" }, { \"name\": \"Koburrito\", \"description\": \"Rollo crocante envuelto en un wrap con relleno de kani queso, masago y aguacate.\", \"price\": \"$6.25\", \"image\": \"./static/images/koburrito.jpg\" } ] }, { \"title\": \"Tus Favoritos\", \"items\": [ { \"name\": \"15 Bocados\", \"description\": \"15 bocados a elegir entre: california, filadelfia, volcano de camarón o cangrejo, shogún de cangrejo o salmón, kani midori, aka ebi, banana kimiyaki, kioto, vegetariano o salmón crocante con albahaca acompañado de una salsa a elección.\", \"price\": \"$12.50\", \"image\": \"./static/images/favorito1.jpg\" }, { \"name\": \"20 Bocados\", \"description\": \"20 bocados a bocados a elegir entre: california, filadelfia, volcano de camarón o cangrejo, shogún de cangrejo o salmón, kani midori, aka ebi, banana kimiyaki, kioto, vegetariano o salmón crocante con albahaca acompañado con dos salsas a elección.\", \"price\": \"$16.99\", \"image\": \"./static/images/favorito2.jpg\" }, { \"name\": \"30 Bocados\", \"description\": \"30 bocados a elegir entre: california, filadelfia, volcano de camarón o cangrejo, shogún de cangrejo o salmón, kani midori, aka ebi, banana kimiyaki, kioto, vegetariano o salmón crocante con albahaca acompañado de tres salsas a elección.\", \"price\": \"$7.00\", \"image\": \"./static/images/favorito3.jpg\" }, { \"name\": \"40 Bocados\", \"description\": \"40 bocados a elegir entre: california, filadelfia, volcano de camarón o cangrejo, shogún de cangrejo o salmón, kani midori, aka ebi, banana kimiyaki, kioto, vegetariano o salmón crocante con albahaca acompañado cinco salsas a elección.\", \"price\": \"$28.99\", \"image\": \"./static/images/favorito4.jpg\" } ] }, { \"title\": \"Nuestros Favoritos\", \"items\": [ { \"name\": \"15 Bocados\", \"description\": \"15 bocados a elección del chef : medio rollo aka ebi, medio rollo california y medio rollo kioto acompañado de una salsa a elección.\", \"price\": \"$11.99\", \"image\": \"./static/images/favorito5.jpg\" }, { \"name\": \"20 Bocados\", \"description\": \"20 bocados a elección del chef: medio rollo volcano de camarón, medio rollo kani midori, medio rollo kioto, medio rollo sake kani especial, acompañado de dos salsas a elección.\", \"price\": \"$15.99\", \"image\": \"./static/images/favorito6.jpg\" }, { \"name\": \"30 Bocados\", \"description\": \"30 bocados a elección del chef: medio rollo california, medio rollo volcano de cangrejo, medio rollo shogun de salmón, medio rollo salmón crocante con albahaca, medio rollo shogun de langostino y medio rollo anguila especial, acompañado de tres salsas a elección.\", \"price\": \"$21.99\", \"image\": \"./static/images/favorito7.jpg\" }, { \"name\": \"40 Bocados\", \"description\": \"40 bocados a elección del chef: medio rollo california, medio rollo salmón crocante con albahaca, medio rollo kioto, medio rollo filadelfia, medio rollo shogun de cangrejo, medio rollo aka ebi, medio rollo banana kimiyaki y medio rollo merito especial, acompañado de cinco salsas a elección.\", \"price\": \"$27.99\", \"image\": \"./static/images/favorito8.jpg\" } ] }, { \"title\": \"Kombinaciones\", \"items\": [ { \"name\": \"14 Bocados Especiales\", \"description\": \"Medio rollo filadelfia especial, medio rollo kioto, 2 sushi de salmón y 2 kono de wantan de camarón. Servido salsa de soya.\", \"price\": \"$11.50\", \"image\": \"./static/images/kombinacion1.jpg\" }, { \"name\": \"21 Bocados Especiales\", \"description\": \"Medio rollo shogun de langostino, medio rollo kani midori, medio rollo california especial, 4 bocados de sashimi de salmón y 2 sushi de salmón acompañado de salsa de soya y anguila.\", \"price\": \"$16.99\", \"image\": \"./static/images/kombinacion2.jpg\" }, { \"name\": \"Fanátikos\", \"description\": \"Medio rollo kioto, medio rollo california especial, medio rollo anguila especial, 2 sushi de salmón y 2 sushi de kanikama acompañado de salsa de soya y anguila.\", \"price\": \"$19.99\", \"image\": \"./static/images/kombinacion3.jpg\" }, { \"name\": \"Ideal\", \"description\": \"Medio rollo sake kani especial, medio rollo california especial, medio rollo kioto, medio rollo de langostino semi picante, 2 sushi de atún, 2 sushi de salmón y 2 sushi de camarón acompañado de salsas de soya y anguila.\", \"price\": \"$22.99\", \"image\": \"./static/images/kombinacion4.jpg\" } ] }, { \"title\": \"Kombos\", \"items\": [ { \"name\": \"Kombo Ramen\", \"description\": \"Media sopa ramen de lomo, medio rollo aka ebi acompañado de salsa de soya y una bebida a elección.\", \"price\": \"$8.99\", \"image\": \"./static/images/kombo1.jpg\" }, { \"name\": \"Kombo Sayu Ramen\", \"description\": \"Media sopa ramen de lomo, medio rollo volcano de cangrejo, medio rollo california especial, acompañado de salsas de soya y anguila y una bebida a elección.\", \"price\": \"$12.99\", \"image\": \"./static/images/kombo2.jpg\" }, { \"name\": \"Kombo Sayu Mizo\", \"description\": \"Media sopa mizono, medio rollo volcano de cangrejo y medio rollo california especial. Acompañada de salsas de soya o anguila y una bebida a elección. Incluye una bebida.\", \"price\": \"$12.99\", \"image\": \"./static/images/kombo3.jpg\" }, { \"name\": \"Kombo Suru\", \"description\": \"Media sopa tom yum, medio rollo a elección entre volcano de kani, kani midori, kioto o california especial acompañado de salsas de soya o anguila y una bebida a elección.\", \"price\": \"$8.99\", \"image\": \"./static/images/kombo4.jpg\" } ] }, { \"title\": \"Ensaladas\", \"items\": [ { \"name\": \"Ensalada Kobe\", \"description\": \"Con vegetales frescos con finos cortes de pesca, pulpo, kanikama y camarón acompañada de salsa de ajonjolí.\", \"price\": \"$7.99\", \"image\": \"./static/images/ensalada1.jpg\" }, { \"name\": \"Ensalada Hoshi Plus con Camarón\", \"description\": \"Mix de vegetales: Lechuga, rábano, aguacate y wantán crocante y camarón.\", \"price\": \"$2.75\", \"image\": \"./static/images/ensalada2.jpg\" }, { \"name\": \"Ensalada Hoshi Plus con Kanikama\", \"description\": \"Mix de vegetales: Lechuga, rábano, aguacate y wantán crocante y kanikama.\", \"price\": \"$2.75\", \"image\": \"./static/images/ensalada3.jpg\" } ] }, { \"title\": \"Sopas\", \"items\": [ { \"name\": \"Mizono\", \"description\": \"Sopa ligera de mariscos, camarón, pulpo, kanikama, salmón cocidos a la perfección, champiñones con base de pasta miso, toques picantes de togarashi y ají japones.\", \"price\": \"$8.75\", \"image\": \"./static/images/sopa1.jpg\" }, { \"name\": \"Sopa Tom Yum\", \"description\": \"Sopa cremosa, a base de frutos del mar y merito crocante, aromatizada con jengibre, con un toque picante de salsa togarashi.\", \"price\": \"$7.50\", \"image\": \"./static/images/sopa2.jpg\" }, { \"name\": \"Ramen de Lomo\", \"description\": \"Sopa tradicional japonesa con pasta estilo ramen a base de fondo de carne, zanahorias, brotes de soya, esparragos, zuquini y cebollín, con piezas de lomo.\", \"price\": \"$6.75\", \"image\": \"./static/images/sopa3.jpg\" }, { \"name\": \"Ramen de Camarón\", \"description\": \"Sopa tradicional japonesa con pasta estilo ramen a base de fondo de carne, zanahorias, brotes de soya, esparragos, zuquini y cebollín, con piezas de camarón.\", \"price\": \"$6.75\", \"image\": \"./static/images/sopa4.jpg\" } ] }, { \"title\": \"Pokes\", \"items\": [ { \"name\": \"Poke de Salmón\", \"description\": \"Poke con arroz sushi al vapor, zanahoria rallada, maíz dulce, aguacate, wantán crocante, alga norí y ajonjolí con salmón fresco. Servido con 2 salsas a elección.\", \"price\": \"$7.50\", \"image\": \"./static/images/poke1.jpg\" }, { \"name\": \"Poke de Kanikama\", \"description\": \"Poke con arroz sushi al vapor, zanahoria rallada, maíz dulce, aguacate, wantán crocante, alga norí y ajonjolí con kanikama. Servido con 2 salsas a elección.\", \"price\": \"$6.50\", \"image\": \"./static/images/poke2.jpg\" }, { \"name\": \"Poke de Camarón\", \"description\": \"Poke con arroz sushi al vapor, zanahoria rallada, maíz dulce, aguacate, wantán crocante, alga norí y ajonjolí con camarones salteados. Servido con 2 salsas a elección.\", \"price\": \"$7.75\", \"image\": \"./static/images/poke3.jpg\" }, { \"name\": \"Poke de Lomo\", \"description\": \"Poke con arroz sushi al vapor, maíz dulce, portobellos, aguacate, wantán crocante y lomo salteado. Servido con 2 salsas a elección.\", \"price\": \"$7.75\", \"image\": \"./static/images/poke4.jpg\" } ] } ] }`"},
                {"role": "user", "content": message}
            ]
        )
        response_message = completion.choices[0].message.content
        # app.logger.info(completion)
        return jsonify({"response": response_message})
    except Exception as e:
        return jsonify({"error": str(e)})

if __name__ == '__main__':
    app.run(debug=True)
